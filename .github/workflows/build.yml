# =============================================================================
# ARO Programming Language - Multi-Platform Build Pipeline
# =============================================================================
# Builds and tests ARO on Linux, macOS, and Windows using Swift 6.2
# =============================================================================

name: Build
permissions:
  contents: read

on:
  push:
    branches:
      - main
      - 'release/**'
    tags:
      - '*'  # Accept all tag formats (v1.0.0, 0.1.0-alpha.1, etc.)
  pull_request:
    branches:
      - main
      - 'release/**'

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

env:
  SWIFT_VERSION: '6.2.1'

jobs:
  # ===========================================================================
  # Run Tests (Gate for all builds)
  # ===========================================================================
  test:
    name: Test
    runs-on: ubuntu-latest
    container:
      image: swift:6.2-jammy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Cache Swift packages
        uses: actions/cache@v5
        with:
          path: .build
          key: linux-swift-${{ env.SWIFT_VERSION }}-test-${{ hashFiles('Package.resolved') }}

      - name: Run tests
        run: swift test --parallel

  # ===========================================================================
  # Linux Build & Test
  # ===========================================================================
  linux:
    needs: test
    name: Linux
    runs-on: ubuntu-latest
    container:
      image: swift:6.2-jammy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Cache Swift packages
        uses: actions/cache@v5
        with:
          path: .build
          key: linux-swift-${{ env.SWIFT_VERSION }}-v3-${{ hashFiles('Package.resolved') }}

      - name: Build
        run: swift build -c debug

      - name: Run tests
        run: swift test --parallel

      - name: Generate version file
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > Sources/AROVersion/Version.swift << 'EOF'
          // ============================================================
          // Version.swift
          // ARO Version Information
          // ============================================================
          // This file is auto-generated during build

          import Foundation

          public enum AROVersion {
              /// Version from git tag (embedded at build time)
              public static let version: String = "VERSION_PLACEHOLDER"

              /// Short commit hash (embedded at build time)
              public static let commit: String = "COMMIT_PLACEHOLDER"

              /// Build date in ISO 8601 format (embedded at build time)
              public static let buildDate: String = "BUILD_DATE_PLACEHOLDER"

              /// Whether this is a release build
              public static let isRelease: Bool = {
                  !version.contains("-dirty") && !version.hasPrefix("unknown") && !version.hasPrefix("dev")
              }()

              /// Full version string with commit and build date
              public static var fullVersion: String {
                  "\(version) (\(commit)) built on \(buildDate)"
              }

              /// Short version string (just the version)
              public static var shortVersion: String {
                  version
              }
          }
          EOF

          # Replace placeholders with actual values (Linux uses sed without -i '')
          sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" Sources/AROVersion/Version.swift
          sed -i "s|COMMIT_PLACEHOLDER|$COMMIT|g" Sources/AROVersion/Version.swift
          sed -i "s|BUILD_DATE_PLACEHOLDER|$BUILD_DATE|g" Sources/AROVersion/Version.swift

          echo "Generated version file with:"
          echo "  Version: $VERSION"
          echo "  Commit: $COMMIT"
          echo "  Build Date: $BUILD_DATE"

      - name: Build release
        run: swift build -c release --static-swift-stdlib

      - name: Verify CLI
        run: |
          .build/release/aro --help
          .build/release/aro check ./Examples/HelloWorldAPI
          .build/release/aro check ./Examples/UserService

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: aro-linux-amd64
          path: .build/release/aro
          retention-days: 30

  # ===========================================================================
  # macOS Build & Test
  # ===========================================================================
  macos:
    needs: test
    name: macOS
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@364295d9c23900ce04d4e5cc708387921b4e50f9  # v3
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v5
        with:
          path: .build
          key: macos-swift-${{ env.SWIFT_VERSION }}-v4-${{ hashFiles('Package.resolved') }}

      - name: Build
        run: swift build -c debug

      - name: Run tests
        run: swift test --parallel

      - name: Generate version file
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > Sources/AROVersion/Version.swift << 'EOF'
          // ============================================================
          // Version.swift
          // ARO Version Information
          // ============================================================
          // This file is auto-generated during build

          import Foundation

          public enum AROVersion {
              /// Version from git tag (embedded at build time)
              public static let version: String = "VERSION_PLACEHOLDER"

              /// Short commit hash (embedded at build time)
              public static let commit: String = "COMMIT_PLACEHOLDER"

              /// Build date in ISO 8601 format (embedded at build time)
              public static let buildDate: String = "BUILD_DATE_PLACEHOLDER"

              /// Whether this is a release build
              public static let isRelease: Bool = {
                  !version.contains("-dirty") && !version.hasPrefix("unknown") && !version.hasPrefix("dev")
              }()

              /// Full version string with commit and build date
              public static var fullVersion: String {
                  "\(version) (\(commit)) built on \(buildDate)"
              }

              /// Short version string (just the version)
              public static var shortVersion: String {
                  version
              }
          }
          EOF

          # Replace placeholders with actual values
          sed -i '' "s|VERSION_PLACEHOLDER|$VERSION|g" Sources/AROVersion/Version.swift
          sed -i '' "s|COMMIT_PLACEHOLDER|$COMMIT|g" Sources/AROVersion/Version.swift
          sed -i '' "s|BUILD_DATE_PLACEHOLDER|$BUILD_DATE|g" Sources/AROVersion/Version.swift

          echo "Generated version file with:"
          echo "  Version: $VERSION"
          echo "  Commit: $COMMIT"
          echo "  Build Date: $BUILD_DATE"

      - name: Build release
        run: swift build -c release

      - name: Verify CLI
        run: |
          .build/release/aro --help
          .build/release/aro check ./Examples/HelloWorldAPI
          .build/release/aro check ./Examples/UserService

      # ========================================================================
      # Code Signing and Notarization (only for tagged releases)
      # ========================================================================

      - name: Import Code Signing Certificate
        if: github.ref_type == 'tag'
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # Decode certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate
          security import certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A \
            -t cert \
            -f pkcs12 \
            -k $KEYCHAIN_PATH

          # Set keychain search list
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Allow codesign to access keychain
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -s \
            -k "$KEYCHAIN_PASSWORD" \
            $KEYCHAIN_PATH

          # Clean up certificate file
          rm certificate.p12

      - name: Sign Binary
        if: github.ref_type == 'tag'
        run: |
          # Sign the binary
          codesign --sign "Developer ID Application" \
            --timestamp \
            --options runtime \
            --verbose \
            .build/release/aro

          # Verify signature (codesign only - spctl requires notarization)
          codesign --verify --verbose .build/release/aro

      - name: Create ZIP for Notarization
        if: github.ref_type == 'tag'
        run: |
          # Notarization requires .zip, .dmg, or .pkg
          cd .build/release
          zip -r aro.zip aro
          cd ../..

      - name: Notarize Binary
        if: github.ref_type == 'tag'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          # Submit for notarization
          xcrun notarytool submit .build/release/aro.zip \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          # Unzip to get the notarized binary
          cd .build/release
          unzip -o aro.zip
          cd ../..

          # Try to staple the notarization ticket
          # Note: Stapling may not work for standalone executables distributed as tarballs.
          # The binary is still notarized - macOS will verify online when users run it.
          echo "Attempting to staple notarization ticket..."
          if xcrun stapler staple .build/release/aro 2>&1; then
            echo "Stapling successful!"
            xcrun stapler validate .build/release/aro
          else
            echo "Stapling not supported for this binary format (this is normal for CLI tools)."
            echo "Binary is still notarized - macOS will verify online."
          fi

          # Verify the binary signature is valid
          codesign --verify --verbose .build/release/aro
          echo "Binary is signed and notarized successfully!"

      - name: Clean Up Keychain
        if: always() && github.ref_type == 'tag'
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain $KEYCHAIN_PATH
          fi

      # ========================================================================
      # Upload Artifact
      # ========================================================================

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: aro-macos-arm64
          path: .build/release/aro
          retention-days: 30

  # ===========================================================================
  # Windows Build & Test
  # ===========================================================================
  windows:
    needs: test
    name: Windows
    permissions:
      contents: read
    runs-on: windows-latest
    continue-on-error: true  # swift-nio-ssl Windows header issues
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: compnerd/gha-setup-swift@c8363f1001fbb4b12d127c432f9eaadec5f56e8c  # main
        with:
          swift-version: swift-6.2.1-release
          swift-build: 6.2.1-RELEASE

      - name: Build
        run: swift build -c debug

      - name: Run tests
        run: swift test --parallel

      - name: Generate version file
        shell: bash
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          cat > Sources/AROVersion/Version.swift << 'EOF'
          // ============================================================
          // Version.swift
          // ARO Version Information
          // ============================================================
          // This file is auto-generated during build

          import Foundation

          public enum AROVersion {
              /// Version from git tag (embedded at build time)
              public static let version: String = "VERSION_PLACEHOLDER"

              /// Short commit hash (embedded at build time)
              public static let commit: String = "COMMIT_PLACEHOLDER"

              /// Build date in ISO 8601 format (embedded at build time)
              public static let buildDate: String = "BUILD_DATE_PLACEHOLDER"

              /// Whether this is a release build
              public static let isRelease: Bool = {
                  !version.contains("-dirty") && !version.hasPrefix("unknown") && !version.hasPrefix("dev")
              }()

              /// Full version string with commit and build date
              public static var fullVersion: String {
                  "\(version) (\(commit)) built on \(buildDate)"
              }

              /// Short version string (just the version)
              public static var shortVersion: String {
                  version
              }
          }
          EOF

          # Replace placeholders (Windows bash shell)
          sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" Sources/AROVersion/Version.swift
          sed -i "s|COMMIT_PLACEHOLDER|$COMMIT|g" Sources/AROVersion/Version.swift
          sed -i "s|BUILD_DATE_PLACEHOLDER|$BUILD_DATE|g" Sources/AROVersion/Version.swift

          echo "Generated version file with:"
          echo "  Version: $VERSION"
          echo "  Commit: $COMMIT"
          echo "  Build Date: $BUILD_DATE"

      - name: Build release
        run: swift build -c release

      - name: Verify CLI
        run: |
          .build\release\aro.exe --help

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: aro-windows-amd64
          path: .build/release/aro.exe
          retention-days: 30

  # ===========================================================================
  # Integration Tests (test-examples.pl on all platforms)
  # ===========================================================================
  integration-tests:
    needs: [linux, macos, windows]
    name: Integration Tests - ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Linux
            runner: ubuntu-latest
            artifact: aro-linux-amd64
            binary: aro
            shell: bash
          - os: macOS
            runner: macos-15
            artifact: aro-macos-arm64
            binary: aro
            shell: bash
          - os: Windows
            runner: windows-latest
            artifact: aro-windows-amd64
            binary: aro.exe
            shell: bash
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      # ======================================================================
      # Install Swift
      # ======================================================================
      - name: Setup Swift (Linux)
        if: matrix.os == 'Linux'
        run: |
          # Swift is needed for native compilation tests
          wget https://download.swift.org/swift-6.2.1-release/ubuntu2204/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE-ubuntu22.04.tar.gz
          tar xzf swift-6.2.1-RELEASE-ubuntu22.04.tar.gz
          sudo mv swift-6.2.1-RELEASE-ubuntu22.04 /usr/share/swift
          echo "/usr/share/swift/usr/bin" >> $GITHUB_PATH

      - name: Setup Swift (macOS)
        if: matrix.os == 'macOS'
        uses: swift-actions/setup-swift@364295d9c23900ce04d4e5cc708387921b4e50f9  # v3
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Setup Swift (Windows)
        if: matrix.os == 'Windows'
        uses: compnerd/gha-setup-swift@c8363f1001fbb4b12d127c432f9eaadec5f56e8c  # main
        with:
          swift-version: swift-6.2.1-release
          swift-build: 6.2.1-RELEASE

      # ======================================================================
      # Install LLVM
      # ======================================================================
      - name: Install LLVM (Linux)
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y llvm-18 llvm-18-dev
          echo "/usr/lib/llvm-18/bin" >> $GITHUB_PATH

      - name: Install LLVM (macOS)
        if: matrix.os == 'macOS'
        run: |
          brew install llvm@18
          echo "/opt/homebrew/opt/llvm@18/bin" >> $GITHUB_PATH

      - name: Install LLVM (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # LLVM is pre-installed on windows-latest runners
          # Just add to PATH if not already there
          if (Test-Path "C:\Program Files\LLVM\bin") {
            echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "LLVM found and added to PATH"
          } else {
            choco install llvm -y
            echo "C:\Program Files\LLVM\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          }

      # ======================================================================
      # Install Perl Modules
      # ======================================================================
      - name: Setup Perl Build Environment (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # Ensure Strawberry Perl's C compiler is available
          # Windows runners have Strawberry Perl with gcc pre-installed
          $perlPath = (Get-Command perl).Source | Split-Path
          $gccPath = Join-Path (Split-Path $perlPath) "c\bin"
          if (Test-Path $gccPath) {
            echo $gccPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            Write-Host "Added Strawberry Perl C compiler to PATH: $gccPath"
          }

          # Verify compiler is available
          gcc --version

      - name: Install Perl modules (Linux/macOS)
        if: matrix.os != 'Windows'
        run: |
          cpan -T IPC::Run YAML::XS HTTP::Tiny Net::EmptyPort Term::ANSIColor Time::HiRes

      - name: Install Perl modules (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          # Install Perl modules with native compilation support
          cpan -T IPC::Run YAML::XS HTTP::Tiny Net::EmptyPort Term::ANSIColor Time::HiRes

      # ======================================================================
      # Download and Install ARO Binary
      # ======================================================================
      - name: Download ARO artifact
        uses: actions/download-artifact@v7
        with:
          name: ${{ matrix.artifact }}
          path: ./aro-bin

      - name: Prepare ARO binary (Linux/macOS)
        if: matrix.os != 'Windows'
        run: |
          chmod +x ./aro-bin/${{ matrix.binary }}
          echo "ARO_BIN=$GITHUB_WORKSPACE/aro-bin/${{ matrix.binary }}" >> $GITHUB_ENV
          ./aro-bin/${{ matrix.binary }} --version

      - name: Prepare ARO binary (Windows)
        if: matrix.os == 'Windows'
        shell: bash
        run: |
          chmod +x ./aro-bin/${{ matrix.binary }}
          echo "ARO_BIN=$GITHUB_WORKSPACE/aro-bin/${{ matrix.binary }}" >> $GITHUB_ENV
          ./aro-bin/${{ matrix.binary }} --version || true

      # ======================================================================
      # Run Integration Tests
      # ======================================================================
      - name: Run integration tests
        run: |
          chmod +x test-examples.pl
          perl test-examples.pl --verbose

      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: test-failures-${{ matrix.os }}
          path: |
            Examples/**/expected.diff
            Examples/**/expected.txt
          retention-days: 7

  # ===========================================================================
  # Generate Documentation PDF
  # ===========================================================================
  documentation:
    needs: test
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc weasyprint fonts-ibm-plex

      - name: Build PDF
        run: |
          cd Book/TheLanguageGuide
          chmod +x build-pdf.sh
          ./build-pdf.sh

      - name: Upload PDF artifact
        uses: actions/upload-artifact@v6
        with:
          name: aro-language-guide
          path: Book/TheLanguageGuide/output/ARO-Language-Guide.pdf
          retention-days: 30

  # ===========================================================================
  # Create Release (only on tags)
  # ===========================================================================
  release:
    name: Create Release
    needs: [linux, macos, windows, integration-tests, documentation]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Package release assets
        run: |
          # Linux
          cd artifacts/aro-linux-amd64
          chmod +x aro
          tar -czvf ../aro-linux-amd64.tar.gz aro
          cd ../..

          # macOS
          cd artifacts/aro-macos-arm64
          chmod +x aro
          tar -czvf ../aro-macos-arm64.tar.gz aro
          cd ../..

          # Windows
          cd artifacts/aro-windows-amd64
          zip ../aro-windows-amd64.zip aro.exe
          cd ../..

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ARO ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          generate_release_notes: true
          files: |
            artifacts/aro-linux-amd64.tar.gz
            artifacts/aro-macos-arm64.tar.gz
            artifacts/aro-windows-amd64.zip
            artifacts/aro-language-guide/ARO-Language-Guide.pdf
          body: |
            ## ARO Programming Language ${{ steps.version.outputs.version }}

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | Linux | x86_64 | [aro-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aro-linux-amd64.tar.gz) |
            | macOS | Apple Silicon | [aro-macos-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aro-macos-arm64.tar.gz) |
            | Windows | x86_64 | [aro-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aro-windows-amd64.zip) |

            ### Documentation

            | Document | Download |
            |----------|----------|
            | ARO Language Guide | [ARO-Language-Guide.pdf](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ARO-Language-Guide.pdf) |

            ### Installation

            **Linux**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aro-linux-amd64.tar.gz | tar xz
            sudo mv aro /usr/local/bin/
            ```

            **macOS**
            ```bash
            curl -L https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/aro-macos-arm64.tar.gz | tar xz
            sudo mv aro /usr/local/bin/
            ```

            **Windows**
            Download and extract the zip file, then add the directory to your PATH.

      # ========================================================================
      # Update Homebrew Formula
      # ========================================================================

      - name: Update Homebrew Formula
        continue-on-error: true
        run: |
          # Calculate SHA256 of the macOS release
          SHA256=$(shasum -a 256 artifacts/aro-macos-arm64.tar.gz | awk '{print $1}')
          VERSION="${{ steps.version.outputs.version }}"

          echo "Version: $VERSION"
          echo "SHA256: $SHA256"

          # Clone homebrew-aro repository
          git clone https://github.com/KrisSimon/homebrew-aro.git
          cd homebrew-aro

          # Update the formula - write directly with proper Ruby formatting
          {
            echo 'class Aro < Formula'
            echo '  desc "ARO programming language - Natural language DSL for business logic"'
            echo '  homepage "https://github.com/KrisSimon/aro"'
            echo "  url \"https://github.com/KrisSimon/aro/releases/download/${{ github.ref_name }}/aro-macos-arm64.tar.gz\""
            echo "  sha256 \"$SHA256\""
            echo "  version \"$VERSION\""
            echo '  license "MIT"'
            echo ''
            echo '  # Only support macOS for now (ARM64 binary)'
            echo '  depends_on :macos'
            echo '  depends_on arch: :arm64'
            echo ''
            echo '  def install'
            echo '    bin.install "aro"'
            echo '  end'
            echo ''
            echo '  test do'
            echo '    assert_match version.to_s, shell_output("#{bin}/aro --version")'
            echo '  end'
            echo 'end'
          } > Formula/aro.rb

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push if there are changes
          git add Formula/aro.rb
          if git diff --staged --quiet; then
            echo "No changes to formula"
          else
            git commit -m "chore: update formula to version $VERSION

          Auto-update from release workflow

          - Version: $VERSION
          - SHA256: $SHA256
          - Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"

            # Push using PAT (requires HOMEBREW_TAP_TOKEN secret with repo permissions)
            git push https://x-access-token:${{ secrets.HOMEBREW_TAP_TOKEN }}@github.com/KrisSimon/homebrew-aro.git main
          fi
