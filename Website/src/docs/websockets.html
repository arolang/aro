{{TEMPLATE:doc-template.html}}
{{title:WebSockets}}
{{content:
<h1 class="gradient-text">WebSockets</h1>

<p>
    ARO provides built-in WebSocket support for real-time bidirectional communication.
    WebSocket connections are established via HTTP Upgrade on the same port as the HTTP server,
    making it easy to add live updates to web applications.
</p>

<h2>Why WebSockets?</h2>

<p>
    Unlike traditional HTTP request-response cycles, WebSocket enables persistent connections
    where both server and client can push data at any time. This is essential for:
</p>

<ul>
    <li><strong>Real-time updates</strong> - Dashboards, notifications, live feeds</li>
    <li><strong>Chat applications</strong> - Instant message delivery</li>
    <li><strong>Collaborative features</strong> - Multi-user editing</li>
    <li><strong>Event streaming</strong> - Logs, sensor data, market feeds</li>
</ul>

<h2>WebSocket Events</h2>

<p>WebSocket lifecycle is managed through three event types:</p>

<table>
    <tr>
        <th>Event</th>
        <th>Handler Name Contains</th>
        <th>Triggered When</th>
    </tr>
    <tr>
        <td>Connect</td>
        <td>"Connect"</td>
        <td>Client completes WebSocket handshake</td>
    </tr>
    <tr>
        <td>Message</td>
        <td>"Message"</td>
        <td>Client sends a text message</td>
    </tr>
    <tr>
        <td>Disconnect</td>
        <td>"Disconnect"</td>
        <td>Connection closes</td>
    </tr>
</table>

<h2>Event Handlers</h2>

<p>Handle WebSocket events using the <code>WebSocket Event Handler</code> business activity pattern:</p>

<h3>Connection Handler</h3>

<pre><code><span class="feature-name">(Handle WebSocket Connect: WebSocket Event Handler)</span> {
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;connection-id&gt;</span> from the <span class="result">&lt;event: id&gt;</span>.
    <span class="action">&lt;Log&gt;</span> <span class="string">"WebSocket client connected"</span> to the <span class="result">&lt;console&gt;</span>.
    <span class="action">&lt;Return&gt;</span> an <span class="result">&lt;OK: status&gt;</span> for the <span class="result">&lt;connection&gt;</span>.
}</code></pre>

<p>The <code>event</code> object provides:</p>
<ul>
    <li><code>id</code> - Unique connection identifier</li>
    <li><code>path</code> - WebSocket path (e.g., "/ws")</li>
    <li><code>remoteAddress</code> - Client IP address</li>
</ul>

<h3>Message Handler</h3>

<pre><code><span class="feature-name">(Handle WebSocket Message: WebSocket Event Handler)</span> {
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;message&gt;</span> from the <span class="result">&lt;event: message&gt;</span>.
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;connection-id&gt;</span> from the <span class="result">&lt;event: connectionId&gt;</span>.
    <span class="action">&lt;Log&gt;</span> <span class="result">&lt;message&gt;</span> to the <span class="result">&lt;console&gt;</span>.
    <span class="action">&lt;Return&gt;</span> an <span class="result">&lt;OK: status&gt;</span> for the <span class="result">&lt;message&gt;</span>.
}</code></pre>

<h3>Disconnection Handler</h3>

<pre><code><span class="feature-name">(Handle WebSocket Disconnect: WebSocket Event Handler)</span> {
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;connection-id&gt;</span> from the <span class="result">&lt;event: connectionId&gt;</span>.
    <span class="action">&lt;Log&gt;</span> <span class="string">"WebSocket client disconnected"</span> to the <span class="result">&lt;console&gt;</span>.
    <span class="action">&lt;Return&gt;</span> an <span class="result">&lt;OK: status&gt;</span> for the <span class="result">&lt;disconnection&gt;</span>.
}</code></pre>

<h2>Broadcasting Messages</h2>

<p>Send a message to all connected WebSocket clients:</p>

<pre><code><span class="action">&lt;Broadcast&gt;</span> the <span class="result">&lt;message&gt;</span> to the <span class="result">&lt;websocket&gt;</span>.</code></pre>

<p>
    Messages are automatically serialized to JSON if they are objects.
    This is commonly used when posting new data via HTTP that should be pushed to all connected clients.
</p>

<h2>Complete Example: Real-Time Chat</h2>

<h3>Project Structure</h3>

<pre><code>WebChat/
├── openapi.yaml      # API contract
├── main.aro          # Application lifecycle
├── api.aro           # HTTP route handlers
├── websocket.aro     # WebSocket event handlers
└── templates/
    └── index.html    # Chat UI</code></pre>

<h3>main.aro</h3>

<pre><code><span class="feature-name">(Application-Start: Web Chat)</span> {
    <span class="action">&lt;Log&gt;</span> <span class="string">"Starting Web Chat..."</span> to the <span class="result">&lt;console&gt;</span>.
    <span class="action">&lt;Start&gt;</span> the <span class="result">&lt;http-server&gt;</span> with {}.
    <span class="action">&lt;Keepalive&gt;</span> the <span class="result">&lt;application&gt;</span> for the <span class="result">&lt;events&gt;</span>.
    <span class="action">&lt;Return&gt;</span> an <span class="result">&lt;OK: status&gt;</span> for the <span class="result">&lt;startup&gt;</span>.
}</code></pre>

<h3>api.aro</h3>

<pre><code><span class="feature-name">(postMessage: Web Chat API)</span> {
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;body&gt;</span> from the <span class="result">&lt;request: body&gt;</span>.
    <span class="action">&lt;Extract&gt;</span> the <span class="result">&lt;text: message&gt;</span> from the <span class="result">&lt;body&gt;</span>.
    <span class="action">&lt;Create&gt;</span> the <span class="result">&lt;message: Message&gt;</span> with {
        message: <span class="result">&lt;text&gt;</span>,
        createdAt: <span class="result">&lt;now&gt;</span>
    }.
    <span class="action">&lt;Store&gt;</span> the <span class="result">&lt;message&gt;</span> into the <span class="result">&lt;message-repository&gt;</span>.

    <span class="comment">(* Broadcast to all WebSocket clients *)</span>
    <span class="action">&lt;Broadcast&gt;</span> the <span class="result">&lt;message&gt;</span> to the <span class="result">&lt;websocket&gt;</span>.

    <span class="action">&lt;Return&gt;</span> a <span class="result">&lt;Created: status&gt;</span> with <span class="result">&lt;message&gt;</span>.
}</code></pre>

<h3>Client JavaScript</h3>

<pre><code>// Connect to WebSocket
const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
const ws = new WebSocket(`${protocol}//${location.host}/ws`);

ws.onopen = () => console.log('Connected');

ws.onmessage = (event) => {
    const message = JSON.parse(event.data);
    displayMessage(message);
};

ws.onclose = () => {
    console.log('Disconnected, reconnecting...');
    setTimeout(connect, 3000);
};</code></pre>

<h2>WebSocket Path</h2>

<p>By default, WebSocket connections are accepted on <code>/ws</code>:</p>

<pre><code>const ws = new WebSocket('ws://localhost:8080/ws');</code></pre>

<h2>Best Practices</h2>

<ul>
    <li><strong>Use HTTP for commands, WebSocket for updates</strong> - Post via HTTP, broadcast via WebSocket</li>
    <li><strong>Handle reconnection on client</strong> - Implement automatic reconnect with exponential backoff</li>
    <li><strong>Log connection events</strong> - Track connects/disconnects for debugging</li>
</ul>

<hr>

<p>
    <a href="sockets.html">&larr; TCP Sockets</a> |
    <a href="templates.html">Templates &rarr;</a>
</p>
}}
