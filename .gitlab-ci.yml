# =============================================================================
# ARO Programming Language - GitLab CI/CD Pipeline (Linux Only)
# =============================================================================
# Builds, tests, and releases ARO on Linux using Swift 6.2
# =============================================================================

stages:
  - test
  - build
  - integration
  - documentation
  - release
  - mastodon

variables:
  SWIFT_VERSION: '6.2.3'

# Only run pipelines for main, release branches, tags, merge requests, and schedules
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - "**/*"

# Default settings for all jobs
default:
  interruptible: true

# =============================================================================
# Test Stage - Gate for all builds (main branch only)
# =============================================================================
test:
  stage: test
  image: swift:6.2-jammy
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH =~ /^release\/.*/
  cache:
    key:
      files:
        - Package.resolved
      prefix: swift-test
    paths:
      - .build/
    policy: pull-push
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq wget gnupg software-properties-common
    # Add LLVM APT repository for LLVM 20 (required for Swifty-LLVM)
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
    - echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] http://apt.llvm.org/jammy/ llvm-toolchain-jammy-20 main" > /etc/apt/sources.list.d/llvm.list
    - apt-get update -qq
    - apt-get install -y -qq llvm-20-dev libzstd-dev
    # Create pkg-config file for LLVM
    - |
      cat > /usr/lib/pkgconfig/llvm.pc << 'PKGCONFIG'
      prefix=/usr/lib/llvm-20
      exec_prefix=${prefix}
      libdir=${prefix}/lib
      includedir=${prefix}/include

      Name: LLVM
      Description: Low-level Virtual Machine compiler framework
      Version: 20.1
      Libs: -L${libdir} -lLLVM-20
      Cflags: -I${includedir}
      PKGCONFIG
  script:
    - swift test --parallel
  tags:
    - spencer

# =============================================================================
# Build Stage - Linux Release Build
# =============================================================================
build:linux:
  stage: build
  image: swift:6.2-jammy
  needs:
    - job: test
      optional: true
  cache:
    key:
      files:
        - Package.resolved
      prefix: swift-build
    paths:
      - .build/
    policy: pull-push
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq git wget gnupg software-properties-common
    # Add LLVM APT repository for LLVM 20 (required for Swifty-LLVM)
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
    - echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] http://apt.llvm.org/jammy/ llvm-toolchain-jammy-20 main" > /etc/apt/sources.list.d/llvm.list
    - apt-get update -qq
    - apt-get install -y -qq llvm-20-dev libzstd-dev
    # Create pkg-config file for LLVM
    - |
      cat > /usr/lib/pkgconfig/llvm.pc << 'PKGCONFIG'
      prefix=/usr/lib/llvm-20
      exec_prefix=${prefix}
      libdir=${prefix}/lib
      includedir=${prefix}/include

      Name: LLVM
      Description: Low-level Virtual Machine compiler framework
      Version: 20.1
      Libs: -L${libdir} -lLLVM-20
      Cflags: -I${includedir}
      PKGCONFIG
  script:
    # Debug build
    - swift build -c debug

    # Run tests again to ensure build is valid
    - swift test --parallel

    # Generate version file
    - |
      VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
      COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
      BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

      cat > Sources/AROVersion/Version.swift << 'EOF'
      // ============================================================
      // Version.swift
      // ARO Version Information
      // ============================================================
      // This file is auto-generated during build

      import Foundation

      public enum AROVersion {
          /// Version from git tag (embedded at build time)
          public static let version: String = "VERSION_PLACEHOLDER"

          /// Short commit hash (embedded at build time)
          public static let commit: String = "COMMIT_PLACEHOLDER"

          /// Build date in ISO 8601 format (embedded at build time)
          public static let buildDate: String = "BUILD_DATE_PLACEHOLDER"

          /// Whether this is a release build
          public static let isRelease: Bool = {
              !version.contains("-dirty") && !version.hasPrefix("unknown") && !version.hasPrefix("dev")
          }()

          /// Full version string with commit and build date
          public static var fullVersion: String {
              "\(version) (\(commit)) built on \(buildDate)"
          }

          /// Short version string (just the version)
          public static var shortVersion: String {
              version
          }
      }
      EOF

      # Replace placeholders with actual values
      sed -i "s|VERSION_PLACEHOLDER|$VERSION|g" Sources/AROVersion/Version.swift
      sed -i "s|COMMIT_PLACEHOLDER|$COMMIT|g" Sources/AROVersion/Version.swift
      sed -i "s|BUILD_DATE_PLACEHOLDER|$BUILD_DATE|g" Sources/AROVersion/Version.swift

      echo "Generated version file with:"
      echo "  Version: $VERSION"
      echo "  Commit: $COMMIT"
      echo "  Build Date: $BUILD_DATE"

    # Release build with static Swift stdlib
    - swift build -c release --static-swift-stdlib
    - swift build -c release --product ARORuntime

    # Verify CLI works
    - .build/release/aro --help
    - .build/release/aro check ./Examples/HelloWorldAPI
    - .build/release/aro check ./Examples/UserService

    # Prepare artifact directory
    - mkdir -p aro-dist
    - cp .build/release/aro aro-dist/
    - cp .build/x86_64-unknown-linux-gnu/release/libARORuntime.a aro-dist/

    # Show artifact contents
    - ls -la aro-dist/
  artifacts:
    name: aro-linux-amd64
    paths:
      - aro-dist/
    expire_in: 30 days
  tags:
    - spencer

# =============================================================================
# Integration Tests Stage
# =============================================================================
integration:linux:
  stage: integration
  image: ubuntu:22.04
  needs:
    - job: build:linux
      artifacts: true
  cache:
    key: swift-integration
    paths:
      - /usr/share/swift/
    policy: pull
  before_script:
    # Install dependencies
    - apt-get update -qq
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get install -y -qq wget curl perl llvm-14 clang-14 cpanminus libipc-run-perl libyaml-libyaml-perl libhttp-tiny-perl zlib1g-dev libsqlite3-dev libxml2-dev gnupg software-properties-common

    # Add LLVM APT repository for LLVM 20 (required for aro binary which links against libLLVM-20)
    - wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | gpg --dearmor -o /usr/share/keyrings/llvm-archive-keyring.gpg
    - echo "deb [signed-by=/usr/share/keyrings/llvm-archive-keyring.gpg] http://apt.llvm.org/jammy/ llvm-toolchain-jammy-20 main" > /etc/apt/sources.list.d/llvm.list
    - apt-get update -qq
    - apt-get install -y -qq libllvm20 llvm-20 clang-20

    # Setup LLVM 20 for both aro binary and llc/clang (V2 code generator produces LLVM 20 IR)
    - ln -sf /usr/bin/llc-20 /usr/bin/llc
    - ln -sf /usr/bin/clang-20 /usr/bin/clang
    - export PATH="/usr/lib/llvm-20/bin:$PATH"
    - export LD_LIBRARY_PATH="/usr/lib/llvm-20/lib:$LD_LIBRARY_PATH"

    # Install Swift for native compilation tests
    - wget -q https://download.swift.org/swift-6.2.1-release/ubuntu2204/swift-6.2.1-RELEASE/swift-6.2.1-RELEASE-ubuntu22.04.tar.gz
    - tar xzf swift-6.2.1-RELEASE-ubuntu22.04.tar.gz
    - mv swift-6.2.1-RELEASE-ubuntu22.04 /usr/share/swift
    - export PATH="/usr/share/swift/usr/bin:$PATH"

    # Install Perl modules
    - cpan -T Net::EmptyPort Term::ANSIColor 2>&1 || true

    # Prepare ARO binary
    - chmod +x ./aro-dist/aro
    - export ARO_BIN="$CI_PROJECT_DIR/aro-dist/aro"

    # Copy runtime library to system location
    - mkdir -p /usr/local/lib
    - cp ./aro-dist/libARORuntime.a /usr/local/lib/libARORuntime.a

    # Verify installation
    - ./aro-dist/aro --version
  script:
    - export PATH="/usr/share/swift/usr/bin:/usr/lib/llvm-20/bin:$PATH"
    - export LD_LIBRARY_PATH="/usr/lib/llvm-20/lib:$LD_LIBRARY_PATH"
    - export ARO_BIN="$CI_PROJECT_DIR/aro-dist/aro"
    - export ARO_DEBUG=1  # Enable debug output for ARO-0041 diagnostics

    # Debug: test aro build directly to see errors
    - echo "=== Testing aro build directly ==="
    - which clang && clang --version | head -1
    - which llc && llc --version | head -1
    - ls -la /usr/share/swift/usr/lib/swift/linux/ | head -5
    - ./aro-dist/aro build ./Examples/HelloWorld --verbose 2>&1 || echo "Build failed with exit code $?"

    - chmod +x test-examples.pl
    - perl test-examples.pl --verbose
  artifacts:
    when: on_failure
    name: test-failures-linux
    paths:
      - Examples/**/expected.*
      - Examples/**/testrun.*
      - Examples/**/.build/*.ll
    expire_in: 7 days
  tags:
    - spencer

# =============================================================================
# Documentation Stage
# =============================================================================
documentation:
  stage: documentation
  image: ubuntu:22.04
  needs:
    - job: test
      optional: true
  before_script:
    - apt-get update -qq
    - export DEBIAN_FRONTEND=noninteractive
    - apt-get install -y -qq pandoc weasyprint fonts-ibm-plex python3
  script:
    # Build Language Guide
    - cd Book/TheLanguageGuide
    - chmod +x build-pdf.sh
    - ./build-pdf.sh
    - cd ../..
    # Build Construction Studies
    - cd Book/TheConstructionStudies
    - chmod +x build-pdf.sh
    - ./build-pdf.sh
    - cd ../..
    # Build ARO By Example
    - cd Book/AROByExample
    - chmod +x build-pdf.sh
    - ./build-pdf.sh
  artifacts:
    name: aro-documentation
    paths:
      - Book/TheLanguageGuide/output/ARO-Language-Guide.pdf
      - Book/TheConstructionStudies/output/ARO-Construction-Studies.pdf
      - Book/AROByExample/output/ARO-By-Example.pdf
    expire_in: 30 days
  tags:
    - spencer

# =============================================================================
# Release Stage - Create GitLab Release (tags only)
# =============================================================================
release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - job: build:linux
      artifacts: true
    - job: integration:linux
    - job: documentation
      artifacts: true
  rules:
    - if: $CI_COMMIT_TAG
  before_script:
    - apk add --no-cache tar gzip
  script:
    # Extract version from tag
    - VERSION="${CI_COMMIT_TAG#v}"
    - echo "Version - $VERSION"

    # Package Linux binary
    - cd aro-dist
    - chmod +x aro
    - tar -czvf ../aro-linux-amd64.tar.gz aro libARORuntime.a
    - cd ..

    # Show package contents
    - ls -la aro-linux-amd64.tar.gz
    - ls -la Book/TheLanguageGuide/output/ARO-Language-Guide.pdf || echo "Language Guide PDF not found"
    - ls -la Book/TheConstructionStudies/output/ARO-Construction-Studies.pdf || echo "Construction Studies PDF not found"
    - ls -la Book/AROByExample/output/ARO-By-Example.pdf || echo "ARO By Example PDF not found"

    # Determine if prerelease
    - |
      if echo "$CI_COMMIT_TAG" | grep -q '-'; then
        echo "PRERELEASE=true" >> release.env
      else
        echo "PRERELEASE=false" >> release.env
      fi
  artifacts:
    paths:
      - aro-linux-amd64.tar.gz
      - Book/TheLanguageGuide/output/ARO-Language-Guide.pdf
      - Book/TheConstructionStudies/output/ARO-Construction-Studies.pdf
      - Book/AROByExample/output/ARO-By-Example.pdf
    expire_in: 1 year
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'ARO ${CI_COMMIT_TAG#v}'
    description: |
      ## ARO Programming Language ${CI_COMMIT_TAG#v}

      ### Downloads

      | Platform | Architecture | Download |
      |----------|--------------|----------|
      | Linux | x86_64 | [aro-linux-amd64.tar.gz]($CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG/downloads/aro-linux-amd64.tar.gz) |

      ### Documentation

      | Document | Download |
      |----------|----------|
      | ARO Language Guide | [ARO-Language-Guide.pdf]($CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG/downloads/ARO-Language-Guide.pdf) |
      | ARO Construction Studies | [ARO-Construction-Studies.pdf]($CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG/downloads/ARO-Construction-Studies.pdf) |
      | ARO By Example | [ARO-By-Example.pdf]($CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG/downloads/ARO-By-Example.pdf) |

      ### Installation

      **Linux**
      ```bash
      curl -L $CI_PROJECT_URL/-/releases/$CI_COMMIT_TAG/downloads/aro-linux-amd64.tar.gz | tar xz
      sudo mv aro /usr/local/bin/
      ```
    assets:
      links:
        - name: 'aro-linux-amd64.tar.gz'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/aro-linux-amd64.tar.gz?job=release'
          filepath: '/aro-linux-amd64.tar.gz'
          link_type: 'package'
        - name: 'ARO-Language-Guide.pdf'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/Book/TheLanguageGuide/output/ARO-Language-Guide.pdf?job=release'
          filepath: '/ARO-Language-Guide.pdf'
          link_type: 'other'
        - name: 'ARO-Construction-Studies.pdf'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/Book/TheConstructionStudies/output/ARO-Construction-Studies.pdf?job=release'
          filepath: '/ARO-Construction-Studies.pdf'
          link_type: 'other'
        - name: 'ARO-By-Example.pdf'
          url: '$CI_PROJECT_URL/-/jobs/artifacts/$CI_COMMIT_TAG/raw/Book/AROByExample/output/ARO-By-Example.pdf?job=release'
          filepath: '/ARO-By-Example.pdf'
          link_type: 'other'
  tags:
    - spencer

# =============================================================================
# Docker Stage - Build and Push Docker Images (using Kaniko + Crane)
# =============================================================================
docker:buildsystem:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/aro-buildsystem
  before_script:
    # Create Docker config for registry authentication
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64 -w 0)\"}}}" > /kaniko/.docker/config.json
  script:
    # Determine tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAG="$CI_COMMIT_TAG"
        DESTINATIONS="--destination=$IMAGE_NAME:$TAG --destination=$IMAGE_NAME:latest"
      else
        TAG="latest"
        DESTINATIONS="--destination=$IMAGE_NAME:$TAG"
      fi
    # Build and push with Kaniko
    - /kaniko/executor
      --context=docker/buildsystem/
      --dockerfile=docker/buildsystem/Dockerfile
      --build-arg=ARO_VERSION=${CI_COMMIT_REF_NAME}
      $DESTINATIONS
  tags:
    - spencer

docker:runtime:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
  variables:
    IMAGE_NAME: $CI_REGISTRY_IMAGE/aro-runtime
  before_script:
    # Create Docker config for registry authentication
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n $CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD | base64 -w 0)\"}}}" > /kaniko/.docker/config.json
  script:
    # Determine tag
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        TAG="$CI_COMMIT_TAG"
        DESTINATIONS="--destination=$IMAGE_NAME:$TAG --destination=$IMAGE_NAME:latest"
      else
        TAG="latest"
        DESTINATIONS="--destination=$IMAGE_NAME:$TAG"
      fi
    # Build and push with Kaniko
    - /kaniko/executor
      --context=docker/runtime/
      --dockerfile=docker/runtime/Dockerfile
      $DESTINATIONS
  tags:
    - spencer

# =============================================================================
# Mastodon Stage - Post Daily Cards (scheduled pipelines only)
# =============================================================================
post:mastodon:
  stage: mastodon
  image: node:20-bookworm
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  before_script:
    # Install Puppeteer dependencies for card generation
    - apt-get update -qq
    - apt-get install -y -qq chromium
    - export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
    - export PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
  script:
    - cd cards
    - npm install
    - node generate.js
    - node post-to-mastodon.js
  tags:
    - spencer
